#job_id = 469412575131163

name: CI/CD - Run Databricks Tests

on:
  push:
    branches: [ main ]

jobs:
  databricks-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install Databricks CLI
        run: |
          pip install --upgrade databricks-cli jq

      - name: Trigger Run_Tests_Notebook task
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "Triggering only Run_Tests_Notebook task..."
          run_json=$(databricks jobs runs submit \
            --job-id 469412575131163 \
            --tasks '[{"task_key":"Run_Tests_Notebook"}]' \
            --output JSON)

          run_id=$(echo "$run_json" | jq -r '.run_id')
          echo "Run ID: $run_id"
          echo "$run_id" > run_id.txt

      - name: Wait for Job completion
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          run_id=$(cat run_id.txt)
          echo "Waiting for job to finish..."
          while true; do
            run=$(databricks runs get --run-id $run_id --output JSON)
            state=$(echo "$run" | jq -r '.state.life_cycle_state')
            result=$(echo "$run" | jq -r '.state.result_state')

            echo "State: $state | Result: $result"

            if [[ "$state" == "TERMINATED" ]]; then
              if [[ "$result" == "SUCCESS" ]]; then
                echo "✅ Databricks tests passed"
                exit 0
              else
                echo "❌ Databricks tests failed"
                exit 1
              fi
            fi

            sleep 10
          done
