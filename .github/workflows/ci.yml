#job_id = 3189259000647

name: CI/CD - Run Databricks Tests

on:
  push:
    branches: [ main ]

jobs:
  databricks-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install Databricks CLI
        run: pip install databricks-cli jq

      - name: Trigger Databricks Job
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "Triggering Databricks Job..."
          databricks jobs run-now --job-id 3189259000647

      - name: Wait for Job completion
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          echo "Waiting for job to finish..."

          while true; do
            run=$(databricks runs list --job-id 3189259000647 --limit 1 --output JSON)
            state=$(echo "$run" | jq -r '.runs[0].state.life_cycle_state')
            result=$(echo "$run" | jq -r '.runs[0].state.result_state')

            echo "State: $state | Result: $result"

            if [[ "$state" == "TERMINATED" ]]; then
              if [[ "$result" == "SUCCESS" ]]; then
                echo "✅ Databricks tests passed"
                exit 0
              else
                echo "❌ Databricks tests failed"
                exit 1
              fi
            fi

            sleep 10
          done