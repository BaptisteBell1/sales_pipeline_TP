#job_id = 469412575131163

jobs:
  databricks-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install Databricks CLI
        run: pip install databricks-cli jq

      - name: Run Test Notebook Isolated
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          # Chemin EXACT de ton notebook de test dans le workspace Databricks
          NOTEBOOK_PATH: "/Workspace/Users/bbellamy@aubay.com/sales_pipeline_TP/tests/run_test"
        run: |
          echo "Generating ephemeral run configuration..."

          # 1. On crée le fichier JSON de config.
          # Note: "new_cluster" permet de créer un cluster temporaire optimisé (Job Cluster)
          cat > test_config.json <<EOF
          {
            "run_name": "CI_Tests_${GITHUB_SHA::7}",
            "new_cluster": {
              "spark_version": "13.3.x-scala2.12",
              "node_type_id": "Standard_DS3_v2",
              "num_workers": 1
            },
            "notebook_task": {
              "notebook_path": "$NOTEBOOK_PATH"
            }
          }
          EOF

          echo "Submitting isolated run (skips Main task)..."
          
          # 2. On soumet le run. Databricks crée un run ID unique pour ce test.
          json_output=$(databricks runs submit --json-file test_config.json)
          run_id=$(echo "$json_output" | jq -r '.run_id')
          
          echo "✅ Run submitted! Run ID: $run_id"

          # 3. Boucle de surveillance (Wait Loop)
          while true; do
            run_status=$(databricks runs get --run-id "$run_id")
            
            life_cycle_state=$(echo "$run_status" | jq -r '.state.life_cycle_state')
            result_state=$(echo "$run_status" | jq -r '.state.result_state')

            echo "Run $run_id - Status: $life_cycle_state"

            if [[ "$life_cycle_state" == "TERMINATED" || "$life_cycle_state" == "SKIPPED" || "$life_cycle_state" == "INTERNAL_ERROR" ]]; then
              if [[ "$result_state" == "SUCCESS" ]]; then
                echo "✅ Tests Passed!"
                exit 0
              else
                echo "❌ Tests Failed!"
                url=$(echo "$run_status" | jq -r '.run_page_url')
                echo "Logs: $url"
                exit 1
              fi
            fi

            echo "Waiting 15 seconds..."
            sleep 15
          done